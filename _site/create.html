<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>powerdelivery - Continuous Delivery with PowerShell and Team Foundation Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Continuous Delivery with PowerShell and Team Foundation Server">
    <meta name="author" content="Jayme C Edwards">
    <link href="stylesheets/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      @media (max-width: 980px) {
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
    <link href="stylesheets/bootstrap-responsive.min.css" rel="stylesheet">
	<link href="stylesheets/pygment_trac.css" rel="stylesheet">
	<link href="stylesheets/site.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="/javascripts/html5shiv.js"></script>
    <![endif]-->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="img/favicon.png">
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand">powerdelivery</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="index.html">Home</a></li>
              <li><a href="about.html">About</a></li>
			  <li><a href="setup.html">Setup</a></li>
			  <li><a href="create.html">Create</a></li>
			  <li><a href="use.html">Use</a></li>
			  <li><a href="reference.html">Reference</a></li>
              <li><a href="developing.html">Developing</a></li>
			  <li><a href="help.html">Get help</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row-fluid">
		<div class='row-fluid'>
	<div class='span3'>
		<h5>Article contents</h5>
		<ul class='nav nav-list'>
			<li class='nav-header'>
				<a href='#workstation_prep'>Prepare your workstation</a>
			</li>
			<li class='nav-header'>
				<a href='#add_pipeline'>Add a pipeline to a TFS project</a>
			</li>
			<li>
				<a href='#what_created'>What gets created</a>
			</li>
			<li class='nav-header'>
				<a href='#how_works'>How powerdelivery works</a>
			</li>
			<li class='nav-header'>
				<a href='#environment'>Environment configuration</a>
			</li>
			<li>
				<a href='#config_how_loaded'>How files are loaded</a>
			</li>
			<li>
				<a href='#config_layout'>Layout of files</a>
			</li>
			<li>
				<a href='#config_retrieving_values'>Retrieving values</a>
			</li>
			<li>
				<a href='#config_structs'>Using structures</a>
			</li>
			<li>
				<a href='#config_arrays'>Using arrays</a>
			</li>
			<li class='nav-header'>
				<a href='#matrix'>Matrix of script blocks</a>
			</li>
			<li>
				<a href='#optimized_compilation'>Optimized compilation</a>
			</li>
			<li class='nav-header'>
				<a href='#cmdlets'>Using cmdlets</a>
			</li>
			<li class='nav-header'>
				<a href='#modules'>Using delivery modules</a>
			</li>
			<li>
				<a href='#modules_referencing'>Referencing modules</a>
			</li>
		</ul>
	</div>	
	<div class='span9'>
		<h1>Creating deployment pipelines</h1>
		<p>In <a href='https://en.wikipedia.org/wiki/Continuous_delivery' target='_new'>continuous delivery</a>, the technology that deploys your software assets to a 
		development, test, and eventually production environment is known as a <b>deployment pipeline</b>. 
		This page will help you use powerdelivery to add a deployment pipeline to your <abbr title='Team Foundation Server'>TFS</abbr> 
		project, understand how it works, and guide you in where to place the PowerShell commands that 
		do your automation in your script.</p>
		<a name='workstation_prep'><hr /></a>
		<br />
		<h2>Prepare your workstation for development</h2>
		<p>After you've <a href='setup.html'>setup your environment</a>, 
		you will want to configure the workstation of anyone who will work on the automation scripts 
		to work with powerdelivery. Follow the directions below on the local computer of any developers, 
		testers, or IT operations personnel who will help to create powerdelivery deployment automation.</p>
		<ol>
			<li><h5>Install PowerShell 3.0 on the local computer</h5></li>
			<p>Open an administrative PowerShell prompt and type the following command:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='nb'>Get-Host</span>
</code></pre></div>

			<p>Look for the <i>Version</i> property and make sure it returns at least <b>3.0</b> or greater. If this 
			number is lower (probably 2.0), then <a href='http://www.microsoft.com/en-us/download/details.aspx?id=34595'>download and install PowerShell 3.0</a> before continuing.</p>
			<li><h5>Install Chocolatey on the local computer</h5></li>
			<p>Chocolatey is a package manager for Windows built on <a href='http://www.nuget.org'>nuget</a>. It lets you install software on your computer 
			silently from a command prompt (or script) without needing to click through wizards. You can read a blog post 
			from Scott Hanselman about it <a href='http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx'>here</a>. 
			powerdelivery is distributed through Chocolatey to make it easy to install and update.</p>
			<p>Go to the <a href='http://chocolatey.org/'>Chocolatey website</a> and follow the instructions on the front 
			page for installing it via a command prompt.</p>
			<li><h5>Enable Unsigned PowerShell scripts on the local computer</h5></li>
			<p>I am purchasing a certificate to sign the scripts that come with powerdelivery in the near future. Until then, 
			you need to open an Administrative PowerShell console and run the following command:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='nb'>Set-ExecutionPolicy</span> <span class='n'>Unrestricted</span>
</code></pre></div>

			<li><h5>Install Powerdelivery on the local computer</h5></li>
			<p>From an Administrative PowerShell console, run the following command to install powerdelivery via chocolatey:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='n'>cinst</span> <span class='n'>powerdelivery</span>
</code></pre></div>

			<p>You should <a href='http://chocolatey.org/packages/PowerDelivery'>check the powerdelivery Chocolatey page for updates</a> 
			from time to time. When you find them, update your build agent from an Administrative PowerShell 
			console again with the following command:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='n'>cup</span> <span class='n'>powerdelivery</span>
</code></pre></div>

			<li><h5>Install PowerShell development tools (optional)</h5></li>
			<p>PowerShell 3.0 comes with an <abbr title='Integrated Scripting Environment'>ISE</abbr> that works fairly 
			well for scripting, but you may also consider installing the free version of 
			<a href='http://www.powergui.com'>PowerGUI</a>. You can install PowerGUI via Chocolatey with the 
			following command:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='n'>cinst</span> <span class='n'>powergui</span>
</code></pre></div>

			<p>You might also consider installing <a href='http://notepad-plus-plus.org/'>Notepad++</a> for editing the .yml configuration files used by 
			powerdelivery. Notepad++ has YAML syntax highlighting and you can install it via Chocolatey with the following command:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='n'>cinst</span> <span class='n'>notepadplusplus</span>
</code></pre></div>

		</ol>
		<a name='add_pipeline'><hr /></a>
		<br />
		<h2>Add a pipeline to a TFS project</h2>
		<p>You can enable a <abbr title='Team Foundation Server'>TFS</abbr> project to use powerdelivery in under 
		a minute using the included <b>Add-Pipeline</b> cmdlet (cmdlets are reusable PowerShell functions). This PowerShell cmdlet 
		does the following:</p>
		<ul>
			<li>Uploads files to your <abbr title='Team Foundation Server'>TFS</abbr> project's source control repository used for scripting the automation.</li>
			<li>Creates builds for your <abbr title='Team Foundation Server'>TFS</abbr> project that can be triggered to deploy to each environment.</li>
			<li>Creates security groups on <abbr title='Team Foundation Server'>TFS</abbr> that users can be placed in to allow them to deploy to your test or production environments.</li>
		</ul>
		<p>Perform the following steps to create a deployment pipeline for your TFS project:</p>
		<ol>
			<li><h5>Determine the TFS project</h5></li>
			<p>Using Team Explorer in Visual Studio, locate the project you want to add powerdelivery to 
			and take a note of its name. You can usually find this in the project collection list, or in the 
			source control browser as the "root" folder (prefixed with a $ character)</p>
			<li><h5>Determine the TFS collection URL</h5></li>
			<p>Using Team Explorer again, find the URL of your project collection. This is the URL to the 
			collection of projects itself, not your project.</p>
			<p>If you had a project named "MyProject", this URL might be:</p>
			<pre>http://mytfsserver:8080/tfs</pre>
			<p>And would <b>NOT</b> be:</p>
			<pre>http://mytfsserver:8080/tfs/MyProject (WRONG!)</pre>
			<li><h5>Determine the TFS build controller</h5></li>
			<p>When you <a href='setup.html'>setup your environment for powerdelivery</a>, you installed 
			PowerShell 3.0, Chocolatey, and powerdelivery on your <b>TFS Build Agent</b> computer. TFS uses 
			another service, the <b>TFS Build Controller</b> to orchestrate builds and call your agent to 
			kick one off. You need to find out the name of this computer. If you have the agent and controller 
			installed on the same computer (which many installations of TFS do) this will be the same.</p>
			<li><h5>Determine the UNC path to drop build output into</h5></li>
			<p>When builds run using TFS, they copy the output (.dll files, test results, etc.) into a 
			"drop folder" which is a UNC network share that has write permissions assigned to it by the 
			Active Directory account under which the TFS Build Agent service runs. You need to determine 
			this UNC network share path so that your builds have a place to put their output.</p>
			<li><h5>Pick a pipeline name</h5></li>
			<p>You should select a name that your PowerShell script, the builds created in TFS, and the 
			security groups created in TFS will have. <b>Do not use spaces</b> and it's often best to just 
			use the name of the TFS project.</p>
			<li><h5>Run the Add-Pipeline cmdlet</h5></li>
			<p>Now you have all the information you need to create your pipeline. Open an Administrative 
			PowerShell console and run the <b>Add-Pipeline</b> cmdlet. You can type the following command for help:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='nb'>Get-Help</span> <span class='nb'>Add-Pipeline</span> <span class='n'>-Detailed</span>
</code></pre></div>

			<br />
			<p>As an example, if you gathered the following information during the steps above:</p>
			<ul>
				<li>TFS project: MyProject</li>
				<li>TFS collection: http://myserver:8080/tfs</li>
				<li>TFS controller: MYBUILDCONTROLLER.mydomain.com</li>
				<li>UNC drop folder: \\MYSERVER\MyDrops</li>
				<li>Chosen pipeline name: MyProject</li>
			</ul>
			<br />
			<p>Based on the settings above you would add a deployment pipeline to the project using the PowerShell command below:</p>
			
<div class='highlight'><pre><code class='powershell'><span class='nb'>Add-Pipeline</span> <span class='n'>-Project</span> <span class='s2'>&quot;MyProject&quot;</span> <span class='p'>`</span>
             <span class='n'>-Collection</span> <span class='s2'>&quot;http://myserver:8080/tfs&quot;</span> <span class='p'>`</span>
             <span class='n'>-Controller</span> <span class='s2'>&quot;MYBUILDCONTROLLER.mydomain.com&quot;</span> <span class='p'>`</span>
             <span class='n'>-DropFolder</span> <span class='s2'>&quot;\\MYSERVER\MyDrops&quot;</span> <span class='p'>`</span>
             <span class='n'>-Name</span> <span class='s2'>&quot;MyProject&quot;</span>
</code></pre></div>

		</ol>
		<a name='what_created'><hr /></a>
		<br />
		<h3>What gets created</h3>
		<p>When you add a pipeline to your TFS project, a number of files and artifacts are created. 
		Assuming the example settings above, the following will be created in TFS:</p>
		<h4>Source control files</h4>
		<p>The following files will be added to your TFS source control.</p>
		<p>The PowerShell script to put your deployment automation code in:</p>
		<pre>$/MyProject/MyProject.ps1</pre>
		<p>The YAML files to put your environment configuration in:</p>
		<pre>
$/MyProject/MyProjectCapacityTestEnvironment.yml
$/MyProject/MyProjectCommitEnvironment.yml
$/MyProject/MyProjectTestEnvironment.yml
$/MyProject/MyProjectProductionEnvironment.yml
$/MyProject/MyProjectModules.yml</pre>
		<p>The TFS Build Process Templates. These are Windows Workflow Foundation files that 
		TFS uses to call a powerdelivery script. You should not need to open or understand 
		anything about these files to use powerdelivery and please <b>do not modify these files</b>:</p>
		<pre>
$/MyProject/BuildProcessTemplates/PowerDeliveryTemplate.xaml
$/MyProject/BuildProcessTemplates/PowerDeliveryTemplate.11.xaml
$/MyProject/BuildProcessTemplates/PowerDeliveryChangeSetTemplate.xaml
$/MyProject/BuildProcessTemplates/PowerDeliveryChangeSetTemplate.11.xaml</pre>
		<h4>TFS Builds</h4>
		<p>The following builds will be created for you:</p>
		<pre>
MyProject - Capacity Test
MyProject - Commit
MyProject - Production
MyProject - Test</pre>
		<p>The Commit build will trigger automatically whenever changes are checked-in to 
		the TFS project containing the builds. The rest of the builds must be explicitly 
		triggered manually.</p>
		<h4>TFS Security Groups</h4>
		<p>The following security groups are created for you:</p>
		<pre>
MyProject Test Builders
MyProject CapacityTest Builders
MyProject Production Builders</pre>
		<p>Only users who are added to the above groups will be permitted to trigger 
		builds targeting those environments.</p>
		<a name='how_works'><hr /></a>
		<br />
		<h2>How powerdelivery works</h2>
		<p>To put it simply, powerdelivery runs a PowerShell script. You can choose to run 
		that script on your own computer and it will run a "Local" build. When you trigger 
		a build on <abbr title='Team Foundation Server'>TFS</abbr>, some extra parameters 
		are passed to the script so that it runs a build against the appropriate target 
		environment (Development, Test, Production etc.).</p>
		<a name='environment'><hr /></a>
		<br />
		<h2>Environment configuration</h2>
		<p>The key principle of Continuous Delivery with respect to powerdelivery itself is 
		releasing more frequently, and to do this with confidence requires making sure the 
		automation that happens during deployment in your development and test environment is 
		as close as possible as to what will happen in production.</p>
		<p>Powerdelivery requires you to use simple environment configuration files to capture 
		the differences between environments. See the <a href='setup.html'>setup</a> page for 
		more information about planning your infrastructure so you know what information to put 
		into these files.</p>
		<a name='config_how_loaded'><hr /></a>
		<br />
		<h3>How configuration files are loaded</h3>
		<p>When your build script starts, prior to your code being run, powerdelivery 
		looks in the same directory as your script for a file with the following pattern:</p>
		<pre>[ScriptName][EnvironmentName]Environment.yml</pre>
		<p>where <i>ScriptName</i> is the name of the build script (ending in .ps1) and <i>EnvironmentName</i> 
		is "Local", "Test", or "Production" for example, depending on the target build environment.</p>
		<p>For example, if your script was named "RecipeManager", powerdelivery would expect to find the following environment configuration files:</p>
		<pre>RecipeManagerLocalEnvironment.yml
RecipeManagerCommitEnvironment.yml
RecipeManagerTestEnvironment.yml
RecipeManagerCapacityTestEnvironment.yml
RecipeManagerProductionEnvironment.yml</pre>
		<a name='config_layout'><hr /></a>
		<br />
		<h3>Layout of your configuration files</h3>
		<p>Configuration files use YAML syntax and most of the settings you use will probably be 
		name/value pairs. Remember that these files are only meant to contain settings that are 
		<i>different</i> between your environments.</p>
		<p>Below is an example of three settings in a build that could deploy a website and a 
		database. These are just example settings and the names of the settings do not mean anything 
		special. Your settings can be named whatever you want.</p>
		
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>WebServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyServer</span>
<span class='l-Scalar-Plain'>DatabaseServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDbServer</span>
<span class='l-Scalar-Plain'>DatabaseName</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDatabase</span>
</code></pre></div>

		<p>This is just an example of the settings in one file. You will have these same setting names, 
		but with different <i>values</i>, in all of your environment configuration files. So if we were 
		using the example build name of "RecipeManager" (where our build script is named RecipeManager.ps1) 
		we might have the following contents for our environment configuration files:</p>
		<p><b>RecipeManagerCommitEnvironment.yml</b></p>
		
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>WebServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDevServer</span>
<span class='l-Scalar-Plain'>DatabaseServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDevDbServer</span>
<span class='l-Scalar-Plain'>DatabaseName</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDatabase</span>
</code></pre></div>

		<p><b>RecipeManagerTestEnvironment.yml</b></p>
		
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>WebServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyTestServer</span>
<span class='l-Scalar-Plain'>DatabaseServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyTestDbServer</span>
<span class='l-Scalar-Plain'>DatabaseName</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDatabase</span>
</code></pre></div>

		<p><b>RecipeManagerProductionEnvironment.yml</b></p>
		
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>WebServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyProdServer</span>
<span class='l-Scalar-Plain'>DatabaseServer</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyProdDbServer</span>
<span class='l-Scalar-Plain'>DatabaseName</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDatabase</span>
</code></pre></div>

		<a name='config_retrieving_values'><hr /></a>
		<br />
		<h3>Retrieving values from configuration files</h3>
		<p>There is a cmdlet (PowerShell function) included with powerdelivery that you should call in 
		the <a href='#init_block'>Init</a> block of your script (blocks are described in the next section). This cmdlet is 
		called <a href='reference.html#get_buildsetting_cmdlet'>Get-BuildSetting</a> and takes the name of your setting as its only parameter, and 
		returns the value of that setting from the configuration file appropriate for the target environment 
		your build is running against. The idea is to read in these settings that are specific to the environment 
		as variables and then use them elsewhere in the script to deploy correctly.</p>
		<p>Using our example settings above, we would retrieve these in the <a href='#init_block'>Init</a> block of the script 
		for use throughout our script and set them as variables as follows. Prefixing a variable with <i>script:</i> 
		makes it available not only to that PowerShell script block, but throughout the entire script:</p>
		
<div class='highlight'><pre><code class='powershell'><span class='n'>Init</span> <span class='p'>{</span>
  <span class='nv'>$script:WebServer</span> <span class='p'>=</span> <span class='nb'>Get-BuildSetting</span> <span class='n'>WebServer</span>
  <span class='nv'>$script:DatabaseServer</span> <span class='p'>=</span> <span class='nb'>Get-BuildSetting</span> <span class='n'>DatabaseServer</span>
  <span class='nv'>$script:DatabaseName</span> <span class='p'>=</span> <span class='nb'>Get-BuildSetting</span> <span class='n'>DatabaseName</span>
<span class='p'>}</span>
</code></pre></div>

		<a name='config_structs'><hr /></a>
		<br />
		<h3>Using structures in configuration settings</h3>
		<p>YAML is a flexible format for storing settings. You can also use nested 
		name/value pairs to provide more structure to your settings if desired. If we have 
		the following settings in our configuration file:</p>
		
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>WebSite</span><span class='p-Indicator'>:</span>
  <span class='l-Scalar-Plain'>Server</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyWebServer</span>
  <span class='l-Scalar-Plain'>Port</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyWebPort</span>
<span class='l-Scalar-Plain'>Database</span><span class='p-Indicator'>:</span>
  <span class='l-Scalar-Plain'>Server</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDbServer</span>
  <span class='l-Scalar-Plain'>Database</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyDatabase</span>
</code></pre></div>

		<p>We can retrieve their values instead this way:</p>
		
<div class='highlight'><pre><code class='powershell'><span class='n'>Init</span> <span class='p'>{</span>
  <span class='nv'>$webSiteSettings</span> <span class='p'>=</span> <span class='nb'>Get-BuildSetting</span> <span class='n'>WebSite</span>
  <span class='nv'>$databaseSettings</span> <span class='p'>=</span> <span class='nb'>Get-BuildSetting</span> <span class='n'>Database</span>
		
  <span class='nv'>$script:WebServer</span> <span class='p'>=</span> <span class='nv'>$webSiteSettings</span><span class='p'>.</span><span class='n'>Server</span>
  <span class='nv'>$script:WebPort</span> <span class='p'>=</span> <span class='nv'>$webSiteSettings</span><span class='p'>.</span><span class='n'>Port</span>
		
  <span class='nv'>$script:DatabaseServer</span> <span class='p'>=</span> <span class='nv'>$databaseSettings</span><span class='p'>.</span><span class='n'>Server</span>
  <span class='nv'>$script:DatabaseName</span> <span class='p'>=</span> <span class='nv'>$databaseSettings</span><span class='p'>.</span><span class='n'>Database</span>
<span class='p'>}</span>
</code></pre></div>

		<a name='config_arrays'><hr /></a>
		<br />
		<h3>Using arrays in configuration settings</h3>
		<p>Arrays are a powerful way to store configuration when you want to 
		allow your build to do the same work multiple times driven by configuration. 
		If we have the following settings in our configuration file:</p>
		
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>WebSites</span><span class='p-Indicator'>:</span>
  <span class='l-Scalar-Plain'>Site1</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>Server</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyWebServer1</span>
    <span class='l-Scalar-Plain'>Port</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>80</span>
  <span class='l-Scalar-Plain'>Site2</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>Server</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyWebServer2</span>
    <span class='l-Scalar-Plain'>Port</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>80</span>
  <span class='l-Scalar-Plain'>Site3</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>Server</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>MyWebServer3</span>
    <span class='l-Scalar-Plain'>Port</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>8080</span>
</code></pre></div>

		<p>We can retrieve and loop through their values this way:</p>
		
<div class='highlight'><pre><code class='powershell'><span class='n'>Init</span> <span class='p'>{</span>
  <span class='nv'>$webSiteSettings</span> <span class='p'>=</span> <span class='nb'>Get-BuildSetting</span> <span class='n'>WebSites</span>
<span class='p'>}</span>
<span class='n'>Deploy</span> <span class='p'>{</span>
  <span class='nv'>$webSiteSettings</span><span class='p'>.</span><span class='n'>Keys</span> <span class='p'>|</span> <span class='p'>%</span> <span class='p'>{</span>
    <span class='nv'>$webSite</span> <span class='p'>=</span> <span class='nv'>$webSiteSettings</span><span class='p'>[</span><span class='nv'>$_</span><span class='p'>]</span>	
    <span class='nv'>$server</span> <span class='p'>=</span> <span class='nv'>$webSite</span><span class='p'>.</span><span class='n'>Server</span>
    <span class='nv'>$port</span> <span class='p'>=</span> <span class='nv'>$webSite</span><span class='p'>.</span><span class='n'>Port</span>	
    <span class='s2'>&quot;The web site server is $server and port is $port&quot;</span>
  <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>

		<p>This trivial example simply prints out to the build log the name and port of the 
		web servers and ports. In a more useful build you might deploy to each web site the 
		same set of files in a farm for example.</p>
		<a name='matrix'><hr /></a>
		<br />
		<h2>Matrix of script blocks</h2>
		<p>Once you have <a href='#environment'>configured your environment</a>, 
		you can begin the task of writing the actual automation PowerShell statements that will do the 
		work. These go into script blocks with specific names that represent the phases of a Continuous 
		Delivery deployment pipeline.</p>
		<p>These script blocks are always called in the same order, but depending on the environment 
		the build is targeting, some will be omitted. The table below shows a matrix of the order of execution 
		of these blocks (from top to bottom) and which are called in each environment.</p>
		<table class='table'>
			<tr>
				<th />
				<th colspan='5'><div style='text-align: center'>Target Build Environment</div></th>
			</tr>
			<tr>
				<th style='text-align: center'>PowerShell Script Block</th>
				<th><a href='#local_builds'>Local</a></th>
				<th><a href='#commit_builds'>Commit</a></th>
				<th><a href='#test_builds'>Test</a></th>
				<th><a href='#capacity_test_builds'>CapacityTest</a></th>
				<th><a href='#production_builds'>Production</a></th>
			</tr>
			<tr>
				<td style='text-align: right'><a href='#init_block'>Init</a></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td>  
			</tr>
			<tr>
				<td style='text-align: right'><a href='#compile_block'>Compile</a></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center' /><td style='text-align: center' /><td style='text-align: center' />  
			</tr>
			<tr>
				<td style='text-align: right'><a href='#test_units_block'>TestUnits</a></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center' /><td style='text-align: center' /><td style='text-align: center' />
			</tr>
			<tr>
				<td style='text-align: right'><a href='#setup_environment_block'>SetupEnvironment</a></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td>
			</tr>
			<tr>
				<td style='text-align: right'><a href='#deploy_block'>Deploy</a></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td>
			</tr>
			<tr>
				<td style='text-align: right'><a href='#test_environment_block'>TestEnvironment</a></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center'><i class='icon-ok' /></td>
			</tr>
			<tr>
				<td style='text-align: right'><a href='#test_acceptance_block'>TestAcceptance</a></td><td style='text-align: center' /><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center' /><td style='text-align: center' /><td style='text-align: center' />
			</tr>
			<tr>
				<td style='text-align: right'><a href='#test_capacity_block'>TestCapacity</a></td><td style='text-align: center' /><td style='text-align: center' /><td style='text-align: center' /><td style='text-align: center'><i class='icon-ok' /></td><td style='text-align: center' />
			</tr>
		</table>
		<p>All blocks are optional and you may choose which to include in your pipeline script depending on 
		what features you'd like to support.</p>
		<a name='optimized_compilation'><hr /></a>
		<br />
		<h3>Optimized compilation</h3>
		<p>To confidently promote builds from one environment to another, we want to prevent different compiled 
		assets from making their way into an environment than have already been evaluated in another. To prevent 
		this, the <a href='#compile_build'>Compile</a> block is only called for <a href='#local_build'>Local</a> 
		and <a href='#commit_build'>Commit</a> builds.</p>
		<p>Because of this, any files that are required for the <a href='#setup_environment_block'>SetupEnvironment</a> 
		block or beyond in other environments must be copied to the drop location during <a href='#compile_block'>Compile</a>. Do this by 
		using the <a href='reference.html#publish_buildassets'>Publish-BuildAssets</a> cmdlet before the Compile 
		block ends.</p>
		<a name='cmdlets'><hr /></a>
		<br />
		<h2>Using cmdlets</h2>
		<p>Refer to the <a href='reference.html#cmdlets'>cmdlet reference</a> 
		to see what reusable commands are built in to powerdelivery that you can use in your script blocks. 
		There are many powerful commands that will save you significant time and coding but remember, 
		you can also use any PowerShell scripts or modules you find along with powerdelivery.</p>
		<p>Though they don't force you to, many of the included cmdlets are meant to be called within 
		specific blocks of your script. For example, the <a href='reference.html#get_buildsettings_cmdlet'>Get-BuildSettings</a> 
		cmdlet should be called in the <a href='#init_block'>Init</a> block. The <a href='reference.html#invoke_msbuild_cmdlet'>Invoke-MSBuild</a> 
		cmdlet should be called in the <a href='#compile_block'>Compile</a> block. The <a href='reference.html#invoke_roundhouse_cmdlet'>Invoke-Roundhouse</a> 
		cmdlet should be called in the <a href='#deploy_block'>Deploy</a> block.</p>
		<a name='modules'><hr /></a>
		<br />
		<h2>Using delivery modules</h2>
		<p>The reusable cmdlets included with powerdelivery are easy to use and you just choose a <a href='#matrix'>script block</a> 
		(Init, Compile, Deploy etc.) to call them from. However, there are times when you might want to package 
		up some reusable PowerShell code that does work across more than one of these script blocks. For example, 
		to setup a website, you might want to enable the target environment to use <a href='http://www.iis.net/downloads/microsoft/web-deploy' target='_blank'>Microsoft Web Deploy</a> in the 
		<a href='#setup_environment_block'>SetupEnvironment</a> block, and then do the actual deployment in the 
		<a href='#deploy_block'>Deploy</a> block. To enable this, powerdelivery allows for the use of <b>Delivery Modules</b>.</p>
		<a name='modules_referencing'><hr /></a>
		<br />
		<h3>Referencing modules</h3>
		<p>Before you can begin to use a delivery module, you must add a reference to one in your build script. 
		This is done by calling the <a href='/reference.html#import_delivery_module_cmdlet'>Import-DeliveryModule</a> 
		cmdlet at the top of your script (outside of a block). If you are familiar with the C# programming language, 
		this is analagous to putting a "using" statement at the top of a class file.</p>
		<p>Below is an example of importing the <a href='/reference.html#web_deploy_module'>WebDeploy</a> module 
		included with powerdelivery. See the <a href='/reference.html#modules'>module reference</a> for details of 
		which modules are included with powerdelivery.</p>
		
<div class='highlight'><pre><code class='powershell'><span class='n'>Pipeline</span> <span class='s1'>&#39;MyProduct&#39;</span> <span class='n'>-Version</span> <span class='s1'>&#39;1.0.0&#39;</span>

<span class='nb'>Import-DeliveryModule</span> <span class='n'>WebDeploy</span>
</code></pre></div>

	</div>
</div>
      </div>
      <hr>
      <footer>
        <p align="center">
			<small>powerdelivery is released under the <a href="http://www.opensource.org/licenses/MIT">MIT license</a>.</small>
		</p>
      </footer>
    </div>
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="javascripts/bootstrap.min.js"></script>
	<script src="javascripts/site.js"></script>
  </body>
</html>